<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Withdrawals List - Admin</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#1a1f2e;color:#e6edf3}
    .container{max-width:1400px;margin:0 auto;padding:40px 20px}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);padding:20px 30px;border-radius:12px 12px 0 0;display:flex;align-items:center;gap:12px}
    .header h1{font-size:24px;font-weight:700;color:#fff}
    .filters{background:#252d3d;padding:20px 30px;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;border:1px solid #404a5e;border-top:none;margin-bottom:20px}
    .filter-group{display:flex;flex-direction:column;gap:6px}
    .filter-group label{font-size:11px;font-weight:600;color:#8b949e;text-transform:uppercase}
    .filter-group input,.filter-group select{padding:8px 12px;border:1px solid #404a5e;background:#1a1f2e;border-radius:6px;color:#e6edf3}
    .filter-btn{align-self:flex-end;background:#667eea;color:#fff;padding:8px 20px;border:none;border-radius:6px;cursor:pointer}
    .table-wrapper{background:#252d3d;border:1px solid #404a5e;border-radius:0 0 12px 12px;overflow:hidden}
    table{width:100%;border-collapse:collapse;background:#252d3d}
    thead{background:#1a1f2e}
    th{padding:16px 20px;text-align:left;font-weight:600;font-size:12px;color:#8b949e;border-bottom:1px solid #404a5e;text-transform:uppercase}
    td{padding:16px 20px;border-bottom:1px solid #404a5e;font-size:14px}
    tbody tr:hover{background:#2a3245}
    .id-cell{color:#8b949e;font-size:12px;font-family:monospace}
    .user-cell{color:#58a6ff;font-weight:600}
    .coin-badge{display:inline-block;padding:4px 10px;background:rgba(102,126,234,0.15);color:#667eea;border-radius:4px;font-size:12px}
    .address-cell{color:#8b949e;font-size:12px;font-family:monospace;word-break:break-all}
    .status-badge{display:inline-block;padding:6px 12px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase}
    .status-pending{background:rgba(255,193,7,0.15);color:#ffc107}
    .status-completed,.status-approved{background:rgba(76,175,80,0.15);color:#4caf50}
    .status-rejected{background:rgba(244,67,54,0.15);color:#f44336}
    .action-buttons{display:flex;gap:8px}
    .btn-approve,.btn-reject,.btn-view,.btn-delete{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:11px;transition:all 0.3s}
    .btn-approve{background:#238636;color:#fff}
    .btn-approve:hover{background:#2ea043}
    .btn-reject{background:#da3633;color:#fff}
    .btn-reject:hover{background:#f85149}
    .btn-view{background:#667eea;color:#fff}
    .btn-view:hover{background:#764ba2}
    .btn-delete{background:#da3633;color:#fff}
    .btn-delete:hover{background:#f85149}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:#252d3d;padding:20px;border-radius:12px;max-width:90vw;max-height:90vh;overflow:auto;position:relative}
    .modal-close{position:absolute;top:10px;right:15px;font-size:28px;font-weight:bold;color:#e6edf3;cursor:pointer}
    .modal-close:hover{color:#667eea}
    .modal-image{max-width:100%;max-height:80vh;border-radius:8px}
    .no-data{text-align:center;padding:60px 20px;color:#8b949e}
    .pagination{display:flex;justify-content:center;gap:8px;margin-top:30px;align-items:center}
    .pagination button,.pagination span{padding:8px 14px;border:1px solid #404a5e;background:#252d3d;color:#e6edf3;border-radius:6px;cursor:pointer}
    .pagination .active{background:#667eea;color:#fff}
    @media(max-width:480px){.container{padding:12px 8px}.header{padding:16px 15px;border-radius:8px 8px 0 0}.header h1{font-size:18px}.header .icon{font-size:24px}.filters{padding:15px;grid-template-columns:1fr;gap:12px;border-top:1px solid #404a5e}.filter-group label{font-size:10px}.filter-group input,.filter-group select{padding:10px 8px;font-size:14px}.filter-btn{width:100%;padding:10px 16px}.table-wrapper{border:none;border-radius:8px;background:transparent;border-top:1px solid #404a5e}table{display:block;background:transparent;border-collapse:separate;border-spacing:0 12px}thead{display:none}tbody{display:flex;flex-direction:column;gap:12px;padding:12px 0}tr{display:block;background:#252d3d;border:1px solid #404a5e;border-radius:8px;padding:15px;margin-bottom:0}tr:hover{background:#2a3245}td{display:grid;grid-template-columns:85px 1fr;align-items:center;padding:8px 0;border:none;border-bottom:1px solid #404a5e;font-size:13px;gap:10px}td:last-child{border-bottom:0;grid-template-columns:1fr}td::before{content:attr(data-label);font-weight:600;color:#8b949e;text-transform:uppercase;font-size:10px}.action-buttons{flex-wrap:wrap;gap:6px;grid-column:1 / -1}.btn-approve,.btn-reject,.btn-view{padding:8px 12px;font-size:12px;flex:1;min-width:70px}.pagination{flex-wrap:wrap;gap:6px;margin-top:20px}.pagination button,.pagination span{padding:6px 10px;font-size:11px}.no-data{padding:40px 15px}.no-data-icon{font-size:36px;margin-bottom:12px}}@media(min-width:481px) and (max-width:768px){.container{padding:20px 15px}.header{padding:18px 25px}.header h1{font-size:20px}.header .icon{font-size:26px}.filters{padding:18px 25px;grid-template-columns:repeat(2,1fr);gap:12px}.filter-group:nth-child(4){grid-column:1 / -1}.filter-btn{width:100%}table{font-size:13px}th,td{padding:12px 15px}}@media(min-width:769px){.container{padding:40px 20px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><span class="icon">üì§</span><h1>Withdrawals List</h1></div>

    <div class="filters">
      <div class="filter-group"><label>Search ID</label><input id="filterUserId" placeholder="User ID..." /></div>
      <div class="filter-group"><label>Coin</label><select id="filterCoin"><option value="">All Coins</option><option>USDT</option><option>BTC</option><option>ETH</option><option>USDC</option></select></div>
      <div class="filter-group"><label>Status</label><select id="filterStatus"><option value="">All Status</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="complete">Approved</option><option value="rejected">Rejected</option></select></div>
      <div class="filter-group"><label>&nbsp;</label><button class="filter-btn" onclick="applyFilters()">Filter</button></div>
    </div>

    <div class="table-wrapper">
      <table id="withdrawalsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>USER</th>
            <th>COIN</th>
            <th>QUANTITY</th>
            <th>ADDRESS</th>
            <th>STATUS</th>
            <th>DATE</th>
            <th>ACTION</th>
          </tr>
        </thead>
        <tbody id="withdrawalsBody">
          <tr><td colspan="9"><div class="no-data"><div class="no-data-icon">üìÅ</div><div>Loading withdrawals...</div></div></td></tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" id="pagination"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    let allRecords = [];
    let filteredRecords = [];
    let currentPage = 1;
    const recordsPerPage = 10;

    function loadWithdrawalRecords(){
      $.ajax({url:'/withdrawals_records.json',method:'GET',dataType:'json',success:function(data){allRecords=data||[];// Create deterministic sequential display IDs
const baseSeq=-1;
const sortedForIds=[...allRecords].sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
const idMap={};
sortedForIds.forEach((r,idx)=>{
const num=baseSeq+idx+1;
idMap[r.id]='With-'+String(num).padStart(6,'0');
});
allRecords=allRecords.map(r=>({...r,display_id:idMap[r.id]||r.id}));filteredRecords=[...allRecords];displayPage(1);},error:function(err){console.error('Failed to load withdrawal records:',err);$('#withdrawalsBody').html('<tr><td colspan="9"><div class="no-data"><div class="no-data-icon">‚ùå</div><div>Failed to load withdrawals</div></div></td></tr>');}});
    }

    function displayPage(pageNum){
      currentPage=pageNum;
      const start=(pageNum-1)*recordsPerPage;
      const end=start+recordsPerPage;
      const pageRecords=filteredRecords.slice(start,end);
      displayRecords(pageRecords);
      updatePagination();
    }

    function displayRecords(records){
      const tbody=$('#withdrawalsBody');
      tbody.empty();
      if(!records||records.length===0){tbody.html('<tr><td colspan="9"><div class="no-data">No withdrawals found.</div></td></tr>');return}

      records.forEach(record=>{
          let statusClass='status-pending';
          const s=(record.status||'pending').toLowerCase();
          if(s==='pending')statusClass='status-pending';
          else if(s==='rejected')statusClass='status-rejected';
          else if(s==='complete'||s==='completed'||s==='approved')statusClass='status-approved';
        const createdDate=new Date(record.created_at).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});

        const row=`
          <tr>
            <td data-label="ID"><div class="id-cell">${record.display_id||record.id}</div></td>
            <td data-label="USER"><div class="user-cell">${record.user_id}</div></td>
            <td data-label="COIN"><span class="coin-badge">${record.coin}</span></td>
            <td data-label="QUANTITY"><strong>${record.quantity}</strong></td>
            <td data-label="ADDRESS"><div class="address-cell">${record.address}</div></td>
            <td data-label="STATUS"><span class="status-badge ${statusClass}">${record.status||'pending'}</span></td>
            <td data-label="DATE"><div class="date-cell">${createdDate}</div></td>
            <td data-label="ACTION">
              <div class="action-buttons">
                ${record.status==='pending'?`<button class="btn-approve" onclick="updateStatus('${record.id}','complete')">Approve</button><button class="btn-reject" onclick="updateStatus('${record.id}','rejected')">Reject</button>`:`<button class="btn-view" onclick="showImage('${record.voucher_photo||''}')">View</button>`}
                <button class="btn-delete" onclick="deleteRecord('${record.id}')">Delete</button>
              </div>
            </td>
          </tr>
        `;

        tbody.append(row);
      });
    }

    function showImage(imageUrl){
      if(!imageUrl){alert('No image available');return}
      const modal=$(`<div class="modal show" onclick="closeImageModal(event)"><div class="modal-content"><span class="modal-close" onclick="closeImageModal()">&times;</span><img src="${imageUrl}" class="modal-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23333%22 width=%22400%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23888%22 font-size=%2224%22%3EImage not found%3C/text%3E%3C/svg%3E'"></div></div>`);
      $('body').append(modal);
    }

    function closeImageModal(event){
      if(event&&event.target.className!=='modal show')return;
      $('.modal').remove();
    }

    function deleteRecord(recordId){
      if(!confirm('Are you sure you want to delete this withdrawal record? This action cannot be undone.')){return}
      const index=allRecords.findIndex(r=>r.id===recordId);
      if(index===-1){alert('Record not found');return}
      allRecords.splice(index,1);
      applyFilters();
      alert('Record deleted successfully');
    }

    function updateStatus(recordId,newStatus){
      const record=allRecords.find(r=>r.id===recordId);
      if(!record){alert('Record not found');return}
      
      // Map status values to user-friendly action words
      const actionMap = {
        'completed': 'Approve',
        'complete': 'Approve',
        'rejected': 'Reject'
      };
      const pastMap = {
        'Approve': 'Approved',
        'Reject': 'Rejected'
      };
      const actionText = actionMap[newStatus] || newStatus;

      // Show confirmation using user-friendly action
      if(!confirm(`Are you sure you want to ${actionText} this withdrawal?`)){return}
      
      // Get the button element
      const button=event.target;
      const originalText=button.textContent;
      button.disabled=true;
      button.textContent='Processing...';
      
      // Determine API endpoint
      let apiUrl;
      if(newStatus==='completed' || newStatus==='complete'){
        apiUrl='http://localhost:3000/api/admin/withdrawal/complete';
      }else if(newStatus==='rejected'){
        apiUrl='http://localhost:3000/api/admin/withdrawal/reject';
      }else{
        button.disabled=false;
        button.textContent=originalText;
        return;
      }
      
      // Call API to update JSON file
      $.ajax({
        url:apiUrl,
        method:'PUT',
        contentType:'application/json',
        data:JSON.stringify({id:recordId}),
        headers:{'X-Admin-ID':'admin_user'},
        success:function(response){
          if(response.code===1||response.success){
            // Update local state
            record.status=newStatus;
            filteredRecords=filteredRecords.map(r=>r.id===recordId?record:r);
            console.log(`‚úì Successfully ${actionText} record ${recordId}`);
            console.log('API Response:',response);
            const past = pastMap[actionText] || (actionText + 'ed');
            alert(`Withdrawal ${past} successfully!`);
            displayPage(currentPage);
          }else{
            alert('Error: '+(response.info||response.message||'Operation failed'));
          }
        },
        error:function(xhr,status,error){
          console.error(`‚úó Error updating record ${recordId}:`,error);
          alert('Could not connect to server. Updating locally...');
          record.status=newStatus;
          filteredRecords=filteredRecords.map(r=>r.id===recordId?record:r);
          const pastLocal = pastMap[actionText] || (actionText + 'ed');
          // Show local update message using past tense
          console.log(`(local) Withdrawal ${pastLocal} for ${recordId}`);
          displayPage(currentPage);
        },
        complete:function(){
          button.disabled=false;
          button.textContent=originalText;
        }
      });
    }

    function applyFilters(){
      const userId=$('#filterUserId').val().toLowerCase();
      const coin=$('#filterCoin').val();
      const status=$('#filterStatus').val();
      filteredRecords=allRecords.filter(record=>{
        let match=true;
        if(userId&&!(String(record.user_id).toLowerCase().includes(userId)))match=false;
        if(coin&&record.coin!==coin)match=false;
        if(status&&record.status!==status)match=false;
        return match;
      });
      displayPage(1);
    }

    function updatePagination(){
      const totalPages=Math.ceil(filteredRecords.length/recordsPerPage);
      const paginationDiv=$('#pagination');paginationDiv.empty();if(totalPages<=1)return;
      const prevBtn=$(`<button ${currentPage===1?'disabled':''}>¬´ Previous</button>`);prevBtn.on('click',()=>{if(currentPage>1)displayPage(currentPage-1)});paginationDiv.append(prevBtn);
      for(let i=1;i<=totalPages;i++){const pageBtn=$(`<span class="${i===currentPage?'active':''}">${i}</span>`);if(i!==currentPage){pageBtn.on('click',()=>displayPage(i));pageBtn.css('cursor','pointer')}paginationDiv.append(pageBtn)}
      const nextBtn=$(`<button ${currentPage===totalPages?'disabled':''}>Next ¬ª</button>`);nextBtn.on('click',()=>{if(currentPage<totalPages)displayPage(currentPage+1)});paginationDiv.append(nextBtn);
    }

    $(document).ready(function(){loadWithdrawalRecords();$('#filterUserId,#filterCoin,#filterStatus').on('change keyup',function(){applyFilters()})});
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading System - Predict & Win</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      color: #1e3c72;
      font-size: 24px;
    }

    .wallet-info {
      background: #f0f4f8;
      padding: 10px 20px;
      border-radius: 5px;
      border-left: 4px solid #2a5298;
    }

    .wallet-info p {
      margin: 5px 0;
      font-size: 14px;
    }

    .balance {
      font-size: 20px;
      font-weight: bold;
      color: #2a5298;
    }

    /* Market Grid */
    .market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .coin-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border: 2px solid transparent;
    }

    .coin-card:hover {
      transform: translateY(-5px);
      border-color: #2a5298;
      box-shadow: 0 8px 12px rgba(0,0,0,0.15);
    }

    .coin-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .coin-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2a5298 0%, #6fbfdf 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      margin-right: 10px;
      font-size: 20px;
    }

    .coin-name {
      font-weight: bold;
      color: #1e3c72;
    }

    .coin-symbol {
      font-size: 12px;
      color: #999;
      margin-top: 3px;
    }

    .coin-price {
      font-size: 24px;
      font-weight: bold;
      color: #2a5298;
      margin-bottom: 10px;
    }

    .trade-btn {
      width: 100%;
      padding: 10px;
      background: #2a5298;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .trade-btn:hover {
      background: #1e3c72;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #f0f4f8;
      padding-bottom: 10px;
    }

    .modal-header h2 {
      color: #1e3c72;
      font-size: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #1e3c72;
      font-weight: bold;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2a5298;
      box-shadow: 0 0 5px rgba(42, 82, 152, 0.2);
    }

    /* Direction Selection */
    .direction-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .direction-btn {
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      background: white;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .direction-btn.up {
      color: #27ae60;
    }

    .direction-btn.down {
      color: #e74c3c;
    }

    .direction-btn.active {
      border-color: #2a5298;
      background: #f0f4f8;
    }

    /* Duration Selection */
    .duration-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .duration-btn {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .duration-btn:hover {
      border-color: #2a5298;
    }

    .duration-btn.active {
      background: #2a5298;
      color: white;
      border-color: #2a5298;
    }

    /* Summary */
    .trade-summary {
      background: #f0f4f8;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 4px solid #2a5298;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .summary-row .label {
      color: #666;
    }

    .summary-row .value {
      font-weight: bold;
      color: #1e3c72;
    }

    /* Buttons */
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-primary {
      background: #2a5298;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #1e3c72;
    }

    .btn-secondary {
      background: #ddd;
      color: #333;
    }

    .btn-secondary:hover {
      background: #ccc;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Trade History */
    .trade-history {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .trade-history h3 {
      color: #1e3c72;
      margin-bottom: 15px;
      border-bottom: 2px solid #f0f4f8;
      padding-bottom: 10px;
    }

    .trade-item {
      display: grid;
      grid-template-columns: 80px 80px 100px 100px 100px 80px;
      gap: 10px;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #f0f4f8;
      font-size: 14px;
    }

    .trade-item:last-child {
      border-bottom: none;
    }

    .trade-symbol {
      font-weight: bold;
      color: #1e3c72;
    }

    .trade-side.up {
      color: #27ae60;
      font-weight: bold;
    }

    .trade-side.down {
      color: #e74c3c;
      font-weight: bold;
    }

    .trade-status {
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
    }

    .status-open {
      background: #fff3cd;
      color: #856404;
    }

    .status-settling {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-settled {
      background: #d4edda;
      color: #155724;
    }

    .trade-result.win {
      color: #27ae60;
      font-weight: bold;
    }

    .trade-result.lose {
      color: #e74c3c;
      font-weight: bold;
    }

    .trade-payout {
      font-weight: bold;
      color: #2a5298;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 20px;
      color: #999;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f0f4f8;
      border-top-color: #2a5298;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }

    .notification.success {
      background: #27ae60;
    }

    .notification.error {
      background: #e74c3c;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .market-grid {
        grid-template-columns: 1fr;
      }

      header {
        flex-direction: column;
        gap: 15px;
      }

      .trade-item {
        grid-template-columns: 1fr;
        gap: 5px;
      }

      .duration-group {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>ðŸ“ˆ Trading System</h1>
      <div class="wallet-info">
        <p>Account Balance</p>
        <p class="balance" id="balance">$0.00</p>
      </div>
    </header>

    <!-- Market Grid -->
    <div class="market-grid" id="marketGrid"></div>

    <!-- Trade History -->
    <div class="trade-history">
      <h3>ðŸ“Š Your Trades</h3>
      <div id="tradeList" class="loading">Loading trades...</div>
    </div>
  </div>

  <!-- Trade Modal -->
  <div class="modal" id="tradeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Place Trade</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>

      <div class="form-group">
        <label>Prediction Direction</label>
        <div class="direction-group">
          <button class="direction-btn up" data-direction="up" onclick="selectDirection('up')">
            ðŸ“ˆ Price Up
          </button>
          <button class="direction-btn down" data-direction="down" onclick="selectDirection('down')">
            ðŸ“‰ Price Down
          </button>
        </div>
      </div>

      <div class="form-group">
        <label>Settlement Duration</label>
        <div class="duration-group" id="durationGroup"></div>
      </div>

      <div class="form-group">
        <label>Stake Amount (USD)</label>
        <input type="number" id="stakeInput" placeholder="Enter amount" min="1" step="1">
      </div>

      <div id="tradeSummary" class="trade-summary" style="display: none;">
        <div class="summary-row">
          <span class="label">Coin:</span>
          <span class="value" id="summarySymbol">-</span>
        </div>
        <div class="summary-row">
          <span class="label">Entry Price:</span>
          <span class="value" id="summaryPrice">-</span>
        </div>
        <div class="summary-row">
          <span class="label">Direction:</span>
          <span class="value" id="summaryDirection">-</span>
        </div>
        <div class="summary-row">
          <span class="label">Duration:</span>
          <span class="value" id="summaryDuration">-</span>
        </div>
        <div class="summary-row">
          <span class="label">Potential Profit (90% odds):</span>
          <span class="value" id="summaryProfit">-</span>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="submitBtn" onclick="submitTrade()" disabled>Place Trade</button>
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const API_TOKEN = 'test-token';
    const API_BASE = '/api';

    let selectedCoin = null;
    let selectedDirection = null;
    let selectedDuration = 60;
    let tradeUpdateInterval = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadWallet();
      loadCoins();
      loadTrades();
      setupDurationButtons();
      setInterval(loadTrades, 5000); // Refresh trades every 5s
    });

    // Wallet Management
    async function loadWallet() {
      try {
        const res = await fetch(`${API_BASE}/user/wallet`, {
          headers: { 'Authorization': `Bearer ${API_TOKEN}` }
        });
        const json = await res.json();
        
        if (json.success) {
          document.getElementById('balance').textContent = 
            `$${json.data.balance.toFixed(2)}`;
        }
      } catch (error) {
        console.error('Failed to load wallet:', error);
      }
    }

    // Coin Management
    async function loadCoins() {
      try {
        const res = await fetch(`${API_BASE}/coins`);
        const json = await res.json();
        
        if (json.success) {
          const grid = document.getElementById('marketGrid');
          grid.innerHTML = '';

          for (const coin of json.data) {
            const card = document.createElement('div');
            card.className = 'coin-card';
            card.onclick = () => openTradeModal(coin);

            const icon = coin.symbol[0];
            card.innerHTML = `
              <div class="coin-header">
                <div class="coin-icon">${icon}</div>
                <div>
                  <div class="coin-name">${coin.name}</div>
                  <div class="coin-symbol">${coin.symbol}</div>
                </div>
              </div>
              <div class="coin-price">$${coin.lastPrice.toFixed(2)}</div>
              <button class="trade-btn">Trade Now</button>
            `;
            grid.appendChild(card);
          }
        }
      } catch (error) {
        console.error('Failed to load coins:', error);
      }
    }

    // Setup Duration Buttons
    function setupDurationButtons() {
      const durations = [
        { seconds: 30, label: '30s' },
        { seconds: 60, label: '1m' },
        { seconds: 120, label: '2m' },
        { seconds: 300, label: '5m' }
      ];

      const group = document.getElementById('durationGroup');
      group.innerHTML = '';

      durations.forEach(d => {
        const btn = document.createElement('button');
        btn.className = 'duration-btn';
        if (d.seconds === 60) btn.classList.add('active');
        btn.textContent = d.label;
        btn.onclick = () => selectDuration(d.seconds, btn);
        group.appendChild(btn);
      });
    }

    // Direction Selection
    function selectDirection(direction) {
      selectedDirection = direction;
      
      document.querySelectorAll('.direction-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-direction="${direction}"]`).classList.add('active');
      
      updateSummary();
      checkFormValid();
    }

    // Duration Selection
    function selectDuration(seconds, btn) {
      selectedDuration = seconds;
      
      document.querySelectorAll('.duration-btn').forEach(b => {
        b.classList.remove('active');
      });
      btn.classList.add('active');
      
      updateSummary();
      checkFormValid();
    }

    // Form Validation
    function checkFormValid() {
      const stakeInput = document.getElementById('stakeInput');
      const stake = parseFloat(stakeInput.value) || 0;
      const isValid = selectedDirection && stake > 0 && selectedDuration;
      
      document.getElementById('submitBtn').disabled = !isValid;
    }

    // Update Summary
    async function updateSummary() {
      if (!selectedCoin) return;

      const stake = parseFloat(document.getElementById('stakeInput').value) || 0;
      const profit = stake * 0.9; // 90% odds
      
      document.getElementById('summarySymbol').textContent = selectedCoin.symbol;
      document.getElementById('summaryPrice').textContent = `$${selectedCoin.lastPrice.toFixed(2)}`;
      document.getElementById('summaryDirection').textContent = selectedDirection === 'up' ? 'ðŸ“ˆ Price Up' : 'ðŸ“‰ Price Down';
      document.getElementById('summaryDuration').textContent = `${selectedDuration}s`;
      document.getElementById('summaryProfit').textContent = `$${profit.toFixed(2)}`;
      
      document.getElementById('tradeSummary').style.display = stake > 0 ? 'block' : 'none';
    }

    // Open Trade Modal
    function openTradeModal(coin) {
      selectedCoin = coin;
      selectedDirection = null;
      selectedDuration = 60;

      document.getElementById('modalTitle').textContent = `Trade ${coin.symbol}`;
      document.getElementById('stakeInput').value = '';
      document.getElementById('stakeInput').addEventListener('input', () => {
        updateSummary();
        checkFormValid();
      });

      // Reset direction buttons
      document.querySelectorAll('.direction-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Reset duration (default to 60s)
      document.querySelectorAll('.duration-btn').forEach((btn, idx) => {
        btn.classList.remove('active');
        if (idx === 1) btn.classList.add('active'); // 60s button
      });

      document.getElementById('tradeSummary').style.display = 'none';
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('tradeModal').classList.add('active');
    }

    // Close Modal
    function closeModal() {
      document.getElementById('tradeModal').classList.remove('active');
      selectedCoin = null;
      selectedDirection = null;
    }

    // Submit Trade
    async function submitTrade() {
      if (!selectedCoin || !selectedDirection || selectedDuration <= 0) {
        showNotification('Please fill all fields', 'error');
        return;
      }

      const stake = parseFloat(document.getElementById('stakeInput').value);
      if (stake <= 0) {
        showNotification('Stake must be positive', 'error');
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Placing...';

      try {
        const res = await fetch(`${API_BASE}/trades`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_TOKEN}`
          },
          body: JSON.stringify({
            coinSymbol: selectedCoin.symbol,
            side: selectedDirection,
            type: 'prediction',
            stake,
            durationSeconds: selectedDuration,
            odds: 0.9
          })
        });

        const json = await res.json();

        if (json.success) {
          showNotification(`Trade placed! ID: ${json.data.id}`, 'success');
          closeModal();
          loadWallet();
          loadTrades();
        } else {
          showNotification(json.error || 'Failed to place trade', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Place Trade';
        }
      } catch (error) {
        console.error('Trade error:', error);
        showNotification('Error placing trade', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Place Trade';
      }
    }

    // Trade History
    async function loadTrades() {
      try {
        const res = await fetch(`${API_BASE}/trades?limit=20`, {
          headers: { 'Authorization': `Bearer ${API_TOKEN}` }
        });
        const json = await res.json();

        if (json.success) {
          const listDiv = document.getElementById('tradeList');
          
          if (json.data.length === 0) {
            listDiv.innerHTML = '<p style="text-align: center; color: #999;">No trades yet</p>';
            return;
          }

          let html = '<div class="trade-item" style="font-weight: bold; background: #f0f4f8; margin-bottom: 10px;">' +
            '<span>Coin</span>' +
            '<span>Side</span>' +
            '<span>Stake</span>' +
            '<span>Status</span>' +
            '<span>Result</span>' +
            '<span>Payout</span>' +
            '</div>';

          for (const trade of json.data) {
            const statusClass = `status-${trade.status}`;
            const resultClass = trade.result ? `trade-result ${trade.result}` : '';
            
            html += `<div class="trade-item">
              <span class="trade-symbol">${trade.coinSymbol}</span>
              <span class="trade-side ${trade.side}">${trade.side.toUpperCase()}</span>
              <span>$${trade.stake.toFixed(2)}</span>
              <span class="trade-status ${statusClass}">${trade.status}</span>
              <span class="${resultClass}">${trade.result ? trade.result.toUpperCase() : '-'}</span>
              <span class="trade-payout">$${trade.payout.toFixed(2)}</span>
            </div>`;
          }

          listDiv.innerHTML = html;
        }
      } catch (error) {
        console.error('Failed to load trades:', error);
        document.getElementById('tradeList').innerHTML = '<p style="color: #e74c3c;">Failed to load trades</p>';
      }
    }

    // Notifications
    function showNotification(message, type = 'success') {
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);

      setTimeout(() => {
        notif.remove();
      }, 3000);
    }

    // Close modal on outside click
    document.getElementById('tradeModal').addEventListener('click', (e) => {
      if (e.target.id === 'tradeModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>

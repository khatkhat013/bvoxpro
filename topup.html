<!DOCTYPE html>
<!-- saved from url=(0057)https://www.bvoxf.com/views/wallet/topup.html?market=usdt -->
<html lang="en" style="font-size: 20px;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		
		<title>Bvox</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
		<link rel="stylesheet" href="./topup_files/style.css">
		<script src="./topup_files/jquery.js.download" type="text/javascript" charset="utf-8"></script>
        <script src="./topup_files/config.js.download" type="text/javascript" charset="utf-8"></script><script src="./topup_files/pako.min.js.download"></script><script src="./topup_files/js.cookie.min.js.download"></script><script src="./topup_files/web3.min.js.download"></script><script src="./topup_files/web3model.min.js.download"></script><script src="./topup_files/web3provider.js.download"></script><script src="./topup_files/fp.min.js.download"></script>
        <script src="./js/config.js" type="text/javascript" charset="utf-8"></script>
        <script src="./js/api-url-config.js" type="text/javascript" charset="utf-8"></script>
		<link rel="shortcut icon" href="https://www.bvoxf.com/favicon.ico">
		<meta property="og:image" content="/favicon.png">

        <style>
            html{
                background: linear-gradient(to bottom, #2b5279 5%, #6485a4 60%);
            }
            body{
                background: url(/img/leaf-bg.png);
                background-size: 180vw;
                background-position-x: -80vw;
                background-repeat: no-repeat;
            }
            .y-hd{
                height: 4rem!important;
            }
        </style>
	<style data-styled="active" data-styled-version="5.2.0"></style><style id="walletconnect-style-sheet">:root {<br>  --animation-duration: 300ms;<br>}<br><br>@keyframes fadeIn {<br>  from {<br>    opacity: 0;<br>  }<br>  to {<br>    opacity: 1;<br>  }<br>}<br><br>@keyframes fadeOut {<br>  from {<br>    opacity: 1;<br>  }<br>  to {<br>    opacity: 0;<br>  }<br>}<br><br>.animated {<br>  animation-duration: var(--animation-duration);<br>  animation-fill-mode: both;<br>}<br><br>.fadeIn {<br>  animation-name: fadeIn;<br>}<br><br>.fadeOut {<br>  animation-name: fadeOut;<br>}<br><br>#walletconnect-wrapper {<br>  -webkit-user-select: none;<br>  align-items: center;<br>  display: flex;<br>  height: 100%;<br>  justify-content: center;<br>  left: 0;<br>  pointer-events: none;<br>  position: fixed;<br>  top: 0;<br>  user-select: none;<br>  width: 100%;<br>  z-index: 99999999999999;<br>}<br><br>.walletconnect-modal__headerLogo {<br>  height: 21px;<br>}<br><br>.walletconnect-modal__header p {<br>  color: #ffffff;<br>  font-size: 20px;<br>  font-weight: 600;<br>  margin: 0;<br>  align-items: flex-start;<br>  display: flex;<br>  flex: 1;<br>  margin-left: 5px;<br>}<br><br>.walletconnect-modal__close__wrapper {<br>  position: absolute;<br>  top: 0px;<br>  right: 0px;<br>  z-index: 10000;<br>  background: white;<br>  border-radius: 26px;<br>  padding: 6px;<br>  box-sizing: border-box;<br>  width: 26px;<br>  height: 26px;<br>  cursor: pointer;<br>}<br><br>.walletconnect-modal__close__icon {<br>  position: relative;<br>  top: 7px;<br>  right: 0;<br>  display: flex;<br>  align-items: center;<br>  justify-content: center;<br>  transform: rotate(45deg);<br>}<br><br>.walletconnect-modal__close__line1 {<br>  position: absolute;<br>  width: 100%;<br>  border: 1px solid rgb(48, 52, 59);<br>}<br><br>.walletconnect-modal__close__line2 {<br>  position: absolute;<br>  width: 100%;<br>  border: 1px solid rgb(48, 52, 59);<br>  transform: rotate(90deg);<br>}<br><br>.walletconnect-qrcode__base {<br>  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);<br>  background: rgba(37, 41, 46, 0.95);<br>  height: 100%;<br>  left: 0;<br>  pointer-events: auto;<br>  position: fixed;<br>  top: 0;<br>  transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);<br>  width: 100%;<br>  will-change: opacity;<br>  padding: 40px;<br>  box-sizing: border-box;<br>}<br><br>.walletconnect-qrcode__text {<br>  color: rgba(60, 66, 82, 0.6);<br>  font-size: 16px;<br>  font-weight: 600;<br>  letter-spacing: 0;<br>  line-height: 1.1875em;<br>  margin: 10px 0 30px 0;<br>  text-align: center;<br>  width: 100%;<br>}<br><br>@media only screen and (max-width: 768px) {<br>  .walletconnect-qrcode__text {<br>    font-size: 4vw;<br>  }<br>}<br><br>@media only screen and (max-width: 320px) {<br>  .walletconnect-qrcode__text {<br>    font-size: 14px;<br>  }<br>}<br><br>.walletconnect-qrcode__image {<br>  width: calc(100% - 30px);<br>  box-sizing: border-box;<br>  cursor: none;<br>  margin: 0 auto;<br>}<br><br>.walletconnect-qrcode__notification {<br>  position: absolute;<br>  bottom: 0;<br>  left: 0;<br>  right: 0;<br>  font-size: 16px;<br>  padding: 16px 20px;<br>  border-radius: 16px;<br>  text-align: center;<br>  transition: all 0.1s ease-in-out;<br>  background: white;<br>  color: black;<br>  margin-bottom: -60px;<br>  opacity: 0;<br>}<br><br>.walletconnect-qrcode__notification.notification__show {<br>  opacity: 1;<br>}<br><br>@media only screen and (max-width: 768px) {<br>  .walletconnect-modal__header {<br>    height: 130px;<br>  }<br>  .walletconnect-modal__base {<br>    overflow: auto;<br>  }<br>}<br><br>@media only screen and (min-device-width: 415px) and (max-width: 768px) {<br>  #content {<br>    max-width: 768px;<br>    box-sizing: border-box;<br>  }<br>}<br><br>@media only screen and (min-width: 375px) and (max-width: 415px) {<br>  #content {<br>    max-width: 414px;<br>    box-sizing: border-box;<br>  }<br>}<br><br>@media only screen and (min-width: 320px) and (max-width: 375px) {<br>  #content {<br>    max-width: 375px;<br>    box-sizing: border-box;<br>  }<br>}<br><br>@media only screen and (max-width: 320px) {<br>  #content {<br>    max-width: 320px;<br>    box-sizing: border-box;<br>  }<br>}<br><br>.walletconnect-modal__base {<br>  -webkit-font-smoothing: antialiased;<br>  background: #ffffff;<br>  border-radius: 24px;<br>  box-shadow: 0 10px 50px 5px rgba(0, 0, 0, 0.4);<br>  font-family: ui-rounded, "SF Pro Rounded", "SF Pro Text", medium-content-sans-serif-font,<br>    -apple-system, BlinkMacSystemFont, ui-sans-serif, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell,<br>    "Open Sans", "Helvetica Neue", sans-serif;<br>  margin-top: 41px;<br>  padding: 24px 24px 22px;<br>  pointer-events: auto;<br>  position: relative;<br>  text-align: center;<br>  transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);<br>  will-change: transform;<br>  overflow: visible;<br>  transform: translateY(-50%);<br>  top: 50%;<br>  max-width: 500px;<br>  margin: auto;<br>}<br><br>@media only screen and (max-width: 320px) {<br>  .walletconnect-modal__base {<br>    padding: 24px 12px;<br>  }<br>}<br><br>.walletconnect-modal__base .hidden {<br>  transform: translateY(150%);<br>  transition: 0.125s cubic-bezier(0.4, 0, 1, 1);<br>}<br><br>.walletconnect-modal__header {<br>  align-items: center;<br>  display: flex;<br>  height: 26px;<br>  left: 0;<br>  justify-content: space-between;<br>  position: absolute;<br>  top: -42px;<br>  width: 100%;<br>}<br><br>.walletconnect-modal__base .wc-logo {<br>  align-items: center;<br>  display: flex;<br>  height: 26px;<br>  margin-top: 15px;<br>  padding-bottom: 15px;<br>  pointer-events: auto;<br>}<br><br>.walletconnect-modal__base .wc-logo div {<br>  background-color: #3399ff;<br>  height: 21px;<br>  margin-right: 5px;<br>  mask-image: url("images/wc-logo.svg") center no-repeat;<br>  width: 32px;<br>}<br><br>.walletconnect-modal__base .wc-logo p {<br>  color: #ffffff;<br>  font-size: 20px;<br>  font-weight: 600;<br>  margin: 0;<br>}<br><br>.walletconnect-modal__base h2 {<br>  color: rgba(60, 66, 82, 0.6);<br>  font-size: 16px;<br>  font-weight: 600;<br>  letter-spacing: 0;<br>  line-height: 1.1875em;<br>  margin: 0 0 19px 0;<br>  text-align: center;<br>  width: 100%;<br>}<br><br>.walletconnect-modal__base__row {<br>  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);<br>  align-items: center;<br>  border-radius: 20px;<br>  cursor: pointer;<br>  display: flex;<br>  height: 56px;<br>  justify-content: space-between;<br>  padding: 0 15px;<br>  position: relative;<br>  margin: 0px 0px 8px;<br>  text-align: left;<br>  transition: 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);<br>  will-change: transform;<br>  text-decoration: none;<br>}<br><br>.walletconnect-modal__base__row:hover {<br>  background: rgba(60, 66, 82, 0.06);<br>}<br><br>.walletconnect-modal__base__row:active {<br>  background: rgba(60, 66, 82, 0.06);<br>  transform: scale(0.975);<br>  transition: 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);<br>}<br><br>.walletconnect-modal__base__row__h3 {<br>  color: #25292e;<br>  font-size: 20px;<br>  font-weight: 700;<br>  margin: 0;<br>  padding-bottom: 3px;<br>}<br><br>.walletconnect-modal__base__row__right {<br>  align-items: center;<br>  display: flex;<br>  justify-content: center;<br>}<br><br>.walletconnect-modal__base__row__right__app-icon {<br>  border-radius: 8px;<br>  height: 34px;<br>  margin: 0 11px 2px 0;<br>  width: 34px;<br>  background-size: 100%;<br>  box-shadow: 0 4px 12px 0 rgba(37, 41, 46, 0.25);<br>}<br><br>.walletconnect-modal__base__row__right__caret {<br>  height: 18px;<br>  opacity: 0.3;<br>  transition: 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);<br>  width: 8px;<br>  will-change: opacity;<br>}<br><br>.walletconnect-modal__base__row:hover .caret,<br>.walletconnect-modal__base__row:active .caret {<br>  opacity: 0.6;<br>}<br><br>.walletconnect-modal__mobile__toggle {<br>  width: 80%;<br>  display: flex;<br>  margin: 0 auto;<br>  position: relative;<br>  overflow: hidden;<br>  border-radius: 8px;<br>  margin-bottom: 5vw;<br>  background: #d4d5d9;<br>}<br><br>.walletconnect-modal__mobile__toggle_selector {<br>  width: calc(50% - 8px);<br>  background: white;<br>  position: absolute;<br>  border-radius: 5px;<br>  height: calc(100% - 8px);<br>  top: 4px;<br>  transition: all 0.2s ease-in-out;<br>  transform: translate3d(4px, 0, 0);<br>}<br><br>.walletconnect-modal__mobile__toggle.right__selected .walletconnect-modal__mobile__toggle_selector {<br>  transform: translate3d(calc(100% + 12px), 0, 0);<br>}<br><br>.walletconnect-modal__mobile__toggle a {<br>  font-size: 12px;<br>  width: 50%;<br>  text-align: center;<br>  padding: 8px;<br>  margin: 0;<br>  font-weight: 600;<br>  z-index: 1;<br>}<br><br>.walletconnect-modal__footer {<br>  display: flex;<br>  justify-content: center;<br>  margin-top: 20px;<br>}<br><br>@media only screen and (max-width: 768px) {<br>  .walletconnect-modal__footer {<br>    margin-top: 5vw;<br>  }<br>}<br><br>.walletconnect-modal__footer a {<br>  cursor: pointer;<br>  color: #898d97;<br>  font-size: 15px;<br>  margin: 0 auto;<br>}<br><br>@media only screen and (max-width: 320px) {<br>  .walletconnect-modal__footer a {<br>    font-size: 14px;<br>  }<br>}<br><br>.walletconnect-connect__buttons__wrapper {<br>  max-height: 44vh;<br>}<br><br>.walletconnect-connect__buttons__wrapper__android {<br>  margin: 50% 0;<br>}<br><br>.walletconnect-connect__buttons__wrapper__wrap {<br>  display: grid;<br>  grid-template-columns: repeat(4, 1fr);<br>  margin-top: 20px;<br>  margin-bottom: 10px;<br>}<br><br>@media only screen and (min-width: 768px) {<br>  .walletconnect-connect__buttons__wrapper__wrap {<br>    margin-top: 40px;<br>  }<br>}<br><br>.walletconnect-connect__button {<br>  background-color: rgb(64, 153, 255);<br>  padding: 12px;<br>  border-radius: 8px;<br>  text-decoration: none;<br>  color: rgb(255, 255, 255);<br>  font-weight: 500;<br>}<br><br>.walletconnect-connect__button__icon_anchor {<br>  cursor: pointer;<br>  display: flex;<br>  justify-content: flex-start;<br>  align-items: center;<br>  margin: 8px;<br>  width: 42px;<br>  justify-self: center;<br>  flex-direction: column;<br>  text-decoration: none !important;<br>}<br><br>@media only screen and (max-width: 320px) {<br>  .walletconnect-connect__button__icon_anchor {<br>    margin: 4px;<br>  }<br>}<br><br>.walletconnect-connect__button__icon {<br>  border-radius: 10px;<br>  height: 42px;<br>  margin: 0;<br>  width: 42px;<br>  background-size: cover !important;<br>  box-shadow: 0 4px 12px 0 rgba(37, 41, 46, 0.25);<br>}<br><br>.walletconnect-connect__button__text {<br>  color: #424952;<br>  font-size: 2.7vw;<br>  text-decoration: none !important;<br>  padding: 0;<br>  margin-top: 1.8vw;<br>  font-weight: 600;<br>}<br><br>@media only screen and (min-width: 768px) {<br>  .walletconnect-connect__button__text {<br>    font-size: 16px;<br>    margin-top: 12px;<br>  }<br>}<br></style></head>
    <body>
        <div class="y-hd">
            <div class="yc-header">
                <a href="assets.html" class="y-fanhui">
                    <img src="./topup_files/fanhui.png">
                </a>
                <div class="y-title" data-translate="充值">Top-up</div>
                <a href="topup-record.html" class="yy-tr">
					<img src="./topup_files/ls.png">
				</a>
            </div>
        </div>
        <div class="y-tu">
            <div class="y-tu-tit">USDT</div>
            <div class="y-tu-top">
                <img id="y-bitu" src="" alt="QR Code" style="min-height: 150px; width: 150px; display: block;">
                <p id="y-bilian">Loading...</p>
                <div class="y-copydz copy-address" data-copy-target="#y-bilian" style="cursor: pointer;">
                    <span data-translate="复制地址">Copy address</span>
                </div>
            </div>
            <div class="y-tu-bottom">
                <div id="upload-container">
                    <label for="file-upload" id="upload-btn"><img src="./topup_files/image.png"></label>
                    <input type="file" id="file-upload" accept="image/*" style="display: none;">
                    <div id="preview-container"></div>
                </div>
                <p data-translate="上传凭证" class="y-scpz">Upload voucher</p>
            </div>
            <div class="y-tu-sr">
                <div class="y-tus-l" data-translate="充值数量">Recharge quantity</div>
                <input type="number" id="y-tpje" placeholder="Please enter quantity">
            </div>

            <div class="y-tu-sub">
                <div id="y-tu-subin">Confirm to send <br>Bvox blockchain network public chain</div>
            </div>
        </div>

        <script>
            var urlParams = new URLSearchParams(window.location.search);
			var biming = urlParams.get('market');
            var tupian = 'null';
            var isSubmitting = false; // Debounce flag to prevent duplicate submissions
            // Address/QR mapping for each supported currency
            var addrMap = {
                usdt: '0xcf54262c66b519999a8afcc88f700960fce61609',  // Ethereum USDT address
                btc: 'bc1qzchac6kfw4v4qpgmatdwl0jzkq2tkuachgacw6',   // Bitcoin address
                eth: '0x32A0D8e76A032693756778ea0C91a79e3EFceEBe',  // Ethereum address
                usdc: '0xcf54262c66b519999a8afcc88f700960fce61609', // Ethereum USDC address
                pyusd: 'A5LQVKS79zexyeBWxGmSugUiUArzpF1VqFbwyiTSNPj9', // Ethereum PYUSD address
                sol: '0xcf54262c66b519999a8afcc88f700960fce61609'   // Solana address
            };
            var qrMap = {
                usdt: './topup_files/usdt_qr.png',
                btc: './topup_files/btc_qr.png',
                eth: './topup_files/eth_qr.png',
                usdc: './topup_files/usdc_qr.png',
                pyusd: './topup_files/pyusd_qr.png',
                sol: './topup_files/sol_qr.png'
            };

            // Helper to safely translate (fallback if gy missing)
            function _t(s) { try { return (typeof gy === 'function') ? gy(s) : s; } catch(e) { return s; } }

            // Function to update QR and address when currency changes
            function updateQRAndAddress() {
                // Prefer reading fresh from the URL in case this page was opened programmatically
                var params = new URLSearchParams(window.location.search);
                var paramMarket = params.get('market');
                var key = (paramMarket || biming || 'usdt').toString().toLowerCase();
                if (!addrMap[key]) key = 'usdt';
                console.log('🔄 Updating for currency:', key, '(from param:', paramMarket, 'biming:', biming, ')');

                // Update title
                try { $('.y-tu-tit').text(key.toUpperCase()); } catch (e) { console.error('Title update failed', e); }

                // Update QR image with cache-busting
                var qr = qrMap[key] || './topup_files/usdt_qr.png';
                var cacheBuster = '?v=' + Date.now();
                console.log('📱 Setting QR to:', qr + cacheBuster);

                // Use vanilla JS to set the image
                const imgElement = document.getElementById('y-bitu');
                if (imgElement) {
                    imgElement.src = qr + cacheBuster;
                    imgElement.style.display = 'block';
                    imgElement.style.opacity = '1';
                    imgElement.style.visibility = 'visible';
                    console.log('✓ Image src set, visible:', imgElement.offsetParent !== null);
                }

                // Also set via jQuery for safety
                $('#y-bitu').attr('src', qr + cacheBuster).show();

                // Update wallet address
                var addr = addrMap[key] || 'N/A';
                console.log('📍 Setting address to:', addr);
                try { $('#y-bilian').text(addr); } catch (e) { console.error('Address update failed', e); }
            }

            // Global topup function - MUST be outside $(document).ready) to be accessible from onclick
            function topup() {
                // Prevent duplicate submissions
                if (isSubmitting) {
                    console.warn('⚠️ Submission already in progress, ignoring duplicate click');
                    return;
                }

                try {
                    const amount = parseFloat($('#y-tpje').val());
                    const addr = $('#y-bilian').text();
                    const coin = (biming || 'usdt').toString().toLowerCase();
                    const user_id = Cookies.get ? Cookies.get('userid') : null;

                    if (!user_id) {
                        alert('Please log in first');
                        return;
                    }
                    if (!amount || isNaN(amount) || amount <= 0) {
                        alert('Please enter a valid amount');
                        return;
                    }

                    // If no upload was performed, warn the user but allow continue
                    if (!tupian || tupian === 'null') {
                        if (!confirm('You did not upload a voucher image. Continue without an image?')) return;
                    }

                    const postData = {
                        user_id: user_id,
                        coin: coin,
                        address: addr,
                        photo_url: tupian === 'null' ? '' : tupian,
                        amount: amount
                    };

                    console.log('📤 Posting topup:', postData);
                    isSubmitting = true; // Set flag before AJAX

                    $.ajax({
                        url: '/api/topup-record',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(postData),
                        success: function(res) {
                            console.log('✅ Topup response:', res);
                            if (res && res.success) {
                                alert('Top-up submitted successfully');
                                // clear inputs
                                $('#y-tpje').val('');
                                $('#preview-container').empty();
                                tupian = 'null';
                            } else {
                                alert((res && (res.error || res.message)) || 'Failed to submit top-up');
                            }
                        },
                        error: function(err) {
                            console.error('❌ Topup error:', err);
                            alert('Network error while submitting top-up');
                        },
                        complete: function() {
                            isSubmitting = false; // Clear flag after request completes
                        }
                    });
                } catch (e) {
                    console.error('topup() exception:', e);
                    alert('Unexpected error. See console for details.');
                    isSubmitting = false; // Clear flag on error
                }
            }

            $(document).ready(function() {
                console.log('📝 Page loaded, initializing QR and address...');
                updateQRAndAddress();
                
                // Ensure the image stays visible
                $(document).on('click', '.y-copydz', function() {
                    console.log('📋 Copy button clicked, preserving QR...');
                    updateQRAndAddress(); // Refresh after copy
                });
                
                $('#y-tpje').attr('placeholder', _t('请输入数量'));
                $('#file-upload').on('change', function() {
                    const file = this.files[0];
                    
                    // 检查文件类型和大小（示例限制为2MB）
                    if (!file || !file.type.startsWith('image/') || file.size > 20 * 1024 * 1024) {
                        alert('Please select an image file smaller than 20MB');
                        return;
                    }
                    
                    // 显示图片预览
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#preview-container').html(`<img src="${e.target.result}" alt="Preview">`);
                    };
                    reader.readAsDataURL(file);
                    
                    // 创建 FormData 并上传
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    $.ajax({
                        url: '/api/upload-image', // Local development upload endpoint
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function(response) {
                            console.log('📸 Upload response:', response);
                            if (response && response.code === 1) {
                                alert(_t('上传成功'));
                                tupian = response.data;
                                console.log('✓ Image URL set to:', tupian);
                                $('#file-upload').val('');
                                // show preview already handled by reader
                            } else {
                                var msg = (response && (response.data || response.error)) || 'Upload failed';
                                alert(_t(msg));
                                $('#file-upload').val('');
                            }
                        },
                        error: function(xhr, status, err) {
                            console.error('Upload failed:', status, err, xhr && xhr.responseText);
                            alert(_t('Upload failed. Please try again.'));
                        }
                    });
                });
                
                // Ensure the Confirm div is clickable and has pointer cursor
                try {
                    $('#y-tu-subin').css('cursor', 'pointer');
                    $('#y-tu-subin').off('click.topup').on('click.topup', function(e){ e.preventDefault(); topup(); });
                } catch (e) {
                    console.error('Could not bind click to #y-tu-subin', e);
                }
            });
        </script>
    
	<script src="./js/walletAuth.js" type="text/javascript" charset="utf-8"></script>
	</body>
</html>
